namespace AstrumLoom;

public static class ShapeText
{
    // Simple stroke-based vector glyphs (A-Z, 0-9) built from lines in a unit box (0..1)
    // Coordinates are normalized; scaled to requested width/height at draw time.
    // Each glyph: list of line segments from (x1,y1) to (x2,y2).

    private static Dictionary<char, (List<(double x1, double y1, double x2, double y2)> lines, bool closed)>
        Glyphs = [];
    public static void SetGlyph()
    {
        Glyphs.Clear();
        Glyphs = new()
        {
            ['A'] = (
        [
            (0.1,1, 0.5,0), (0.5,0, 0.9,1), // sides
            (0.25,0.55, 0.75,0.55)          // crossbar
        ], false),
            ['B'] = (
        [
            (0.1,0, 0.1,1), // spine
            (0.1,0, 0.7,0), (0.7,0, 0.9,0.2), (0.9,0.2, 0.7,0.5),
            (0.1,0.5, 0.7,0.5), (0.7,0.5, 0.9,0.8), (0.9,0.8, 0.7,1), (0.7,1, 0.1,1)
        ], false),
            ['C'] = (
        [
            (0.8,0.1, 0.6,0), (0.6,0, 0.2,0), (0.2,0, 0.05,0.2), (0.05,0.2, 0.05,0.8), (0.05,0.8, 0.2,1), (0.2,1, 0.6,1), (0.6,1, 0.8,0.9)
        ], false),
            ['D'] = (
        [
            (0.1,0, 0.1,1), (0.1,0, 0.55,0), (0.55,0, 0.85,0.25), (0.85,0.25, 0.85,0.75), (0.85,0.75, 0.55,1), (0.55,1, 0.1,1)
        ], false),
            ['E'] = (
        [
            (0.1,0, 0.1,1), (0.1,0, 0.8,0), (0.1,0.5, 0.7,0.5), (0.1,1, 0.8,1)
        ], false),
            ['F'] = (
        [
            (0.1,0, 0.1,1), (0.1,0, 0.8,0), (0.1,0.5, 0.7,0.5)
        ], false),
            ['G'] = (
        [
            (0.8,0.1, 0.6,0), (0.6,0, 0.2,0), (0.2,0, 0.05,0.2), (0.05,0.2, 0.05,0.8), (0.05,0.8, 0.2,1), (0.2,1, 0.6,1), (0.6,1, 0.8,0.8),
            (0.6,0.5, 0.9,0.5), (0.9,0.5, 0.9,0.8)
        ], false),
            ['H'] = (
        [
            (0.1,0, 0.1,1), (0.9,0, 0.9,1), (0.1,0.5, 0.9,0.5)
        ], false),
            ['I'] = (
        [
            (0.2,0, 0.8,0), (0.5,0, 0.5,1), (0.2,1, 0.8,1)
        ], false),
            ['J'] = (
        [
            (0.2,1, 0.8,1), (0.8,1, 0.8,0.2), (0.8,0.2, 0.6,0), (0.6,0, 0.3,0)
        ], false),
            ['K'] = (
        [
            (0.1,0, 0.1,1), (0.1,0.5, 0.9,0), (0.1,0.5, 0.9,1)
        ], false),
            ['L'] = (
        [
            (0.1,0, 0.1,1), (0.1,1, 0.8,1)
        ], false),
            ['M'] = (
        [
            (0.1,1, 0.1,0), (0.1,0, 0.5,0.5), (0.5,0.5, 0.9,0), (0.9,0, 0.9,1)
        ], false),
            ['N'] = (
        [
            (0.1,1, 0.1,0), (0.1,0, 0.9,1), (0.9,1, 0.9,0)
        ], false),
            ['O'] = (
        [
            (0.2,0, 0.8,0), (0.8,0, 1,0.2), (1,0.2, 1,0.8), (1,0.8, 0.8,1), (0.8,1, 0.2,1), (0.2,1, 0,0.8), (0,0.8, 0,0.2), (0,0.2, 0.2,0)
        ], false),
            ['P'] = (
        [
            (0.1,0, 0.1,1), (0.1,0, 0.6,0), (0.6,0, 0.8,0.2), (0.8,0.2, 0.6,0.4), (0.6,0.4, 0.1,0.4)
        ], false),
            ['Q'] = (
        [
            // O with a tail
            (0.2,0, 0.8,0), (0.8,0, 1,0.2), (1,0.2, 1,0.8), (1,0.8, 0.8,1), (0.8,1, 0.2,1), (0.2,1, 0,0.8), (0,0.8, 0,0.2), (0,0.2, 0.2,0),
            (0.6,0.6, 1.05,1.05)
        ], false),
            ['R'] = (
        [
            (0.1,0, 0.1,1), (0.1,0, 0.6,0), (0.6,0, 0.8,0.2), (0.8,0.2, 0.6,0.4), (0.6,0.4, 0.1,0.4),
            (0.1,0.4, 0.9,1)
        ], false),
            ['S'] = (
        [
            (0.8,0.1, 0.6,0), (0.6,0, 0.2,0), (0.2,0, 0.05,0.2), (0.05,0.2, 0.6,0.5), (0.6,0.5, 0.95,0.8), (0.95,0.8, 0.8,1), (0.8,1, 0.2,1)
        ], false),
            ['T'] = (
        [
            (0.1,0, 0.9,0), (0.5,0, 0.5,1)
        ], false),
            ['U'] = (
        [
            (0.1,0, 0.1,0.8), (0.1,0.8, 0.3,1), (0.3,1, 0.7,1), (0.7,1, 0.9,0.8), (0.9,0.8, 0.9,0)
        ], false),
            ['V'] = (
        [
            (0.1,0, 0.5,1), (0.5,1, 0.9,0)
        ], false),
            ['W'] = (
        [
            (0.1,0, 0.2,1), (0.2,1, 0.5,0.3), (0.5,0.3, 0.8,1), (0.8,1, 0.9,0)
        ], false),
            ['X'] = (
        [
            (0.1,0, 0.9,1), (0.9,0, 0.1,1)
        ], false),
            ['Y'] = (
        [
            (0.1,0, 0.5,0.5), (0.9,0, 0.5,0.5), (0.5,0.5, 0.5,1)
        ], false),
            ['Z'] = (
        [
            (0.1,0, 0.9,0), (0.9,0, 0.1,1), (0.1,1, 0.9,1)
        ], false),

            ['0'] = (
        [
            (0.2,0, 0.8,0), (0.8,0, 1,0.2), (1,0.2, 1,0.8), (1,0.8, 0.8,1), (0.8,1, 0.2,1), (0.2,1, 0,0.8), (0,0.8, 0,0.2), (0,0.2, 0.2,0),
            (0.8,0.2, 0.2,0.8) // internal diagonal hint
        ], false),
            ['1'] = (
        [
            (0.3,0.2, 0.5,0), (0.5,0, 0.5,1), (0.3,1, 0.7,1)
        ], false),
            ['2'] = (
        [
            (0.2,0, 0.8,0), (0.8,0, 0.95,0.2), (0.95,0.2, 0.2,0.7), (0.2,0.7, 0.2,1), (0.2,1, 0.9,1)
        ], false),
            ['3'] = (
        [
            (0.2,0, 0.8,0), (0.8,0, 1,0.2), (1,0.2, 0.7,0.5), (0.4, 0.5, 0.7, 0.5),(0.7,0.5, 1,0.8), (1,0.8, 0.8,1), (0.8,1, 0.2,1)
        ], false),
            ['4'] = (
        [
            (0.8,0, 0.8,1), (0.2,0.6, 1,0.6), (0.2,0.6, 0.7,0)
        ], false),
            ['5'] = (
        [
            (0.9,0, 0.2,0), (0.2,0, 0.2,0.5), (0.2,0.5, 0.8,0.5), (0.8,0.5, 1,0.7), (1,0.7, 0.8,1), (0.8,1, 0.2,1)
        ], false),
            ['6'] = (
        [
            (0.8,0.1, 0.6,0), (0.6,0, 0.2,0), (0.2,0, 0.05,0.3), (0.05,0.3, 0.05,0.7), (0.05, 0.7, 0.2,0.5),
                (0.2,0.5, 0.7,0.5), (0.7,0.5, 0.9,0.7), (0.9,0.7, 0.7,1), (0.7,1, 0.2,1), (0.2,1, 0.05,0.7)
        ], false),
            ['7'] = (
        [
            (0.1,0, 0.9,0), (0.9,0, 0.3,1)
        ], false),
            ['8'] = (
        [
            (0.2,0, 0.8,0), (0.8,0, 1,0.3), (1,0.3, 0,0.7), (1,0.7, 0.8,1), (0.8,1, 0.2,1), (0.2,1, 0,0.7), (1,0.7, 0,0.3), (0,0.3, 0.2,0)
        ], false),
            ['9'] = (
        [
            (0.2,1, 0.8,1), (0.8,1, 0.95,0.8), (0.95,0.8, 0.8,0.5), (0.8,0.5, 0.3,0.5), (0.3,0.5, 0.1,0.3), (0.1,0.3, 0.3,0),
                (0.3,0, 0.8,0), (0.8,0, 0.95,0.3), (0.95,0.3, 0.8,0.5)
        ], false),
            ['-'] = ([(0.2, 0.5, 0.8, 0.5)], false),
            ['+'] = ([(0.2, 0.5, 0.8, 0.5), (0.5, 0.2, 0.5, 0.8)], false),
            ['*'] = ([(0.2, 0.5, 0.8, 0.5), (0.3, 0.3, 0.7, 0.7), (0.3, 0.7, 0.7, 0.3)], false),
            ['/'] = ([(0.2, 1, 0.8, 0)], false),
            ['\\'] = ([(0.2, 0, 0.8, 1)], false),
            ['|'] = ([(0.5, 0, 0.5, 1)], false),
            ['='] = ([(0.2, 0.35, 0.8, 0.35), (0.2, 0.65, 0.8, 0.65)], false),
            ['.'] = ([(0.45, 0.85, 0.55, 0.95)], false),
            [','] = ([(0.45, 0.85, 0.55, 0.95), (0.55, 0.95, 0.5, 1.1)], false),
            [':'] = ([(0.45, 0.15, 0.55, 0.25), (0.45, 0.75, 0.55, 0.85)], false),
            [';'] = ([(0.45, 0.15, 0.55, 0.25), (0.45, 0.75, 0.55, 0.85), (0.55, 0.85, 0.5, 1.05)], false),
            [' '] = ([], false)
        };
    }

    public static void Draw(double x, double y, string text,
        double size = 24,
        Color? color = null,
        int thickness = 2,
        double letterSpacing = 0.2,
        double wordSpacing = 0.5,
        double widthratio = 1.0,
        BlendMode blend = BlendMode.None,
        double opacity = 1)
    {
        if (Glyphs.Count == 0)
        {
            SetGlyph();
        }
        if (string.IsNullOrEmpty(text)) return;

        double cellW = size * widthratio;          // per glyph width
        double cellH = size;          // per glyph height
        double advance = cellW * (1 + letterSpacing); // advance per glyph
        double spaceratio = (1 + letterSpacing) * wordSpacing;
        double spaceAdvance = cellW * spaceratio;

        double cx = x;
        double cy = y;

        foreach (char rawCh in text)
        {
            char ch = rawCh;
            if (ch == '\n') { cx = x; cy += cellH * (1.0 + wordSpacing); continue; }

            if (!Glyphs.TryGetValue(ch, out var glyph))
            {
                // Try uppercase fallback
                if (!Glyphs.TryGetValue(char.ToUpperInvariant(ch), out glyph))
                {
                    cx += advance; // unknown glyph: skip advance
                    continue;
                }
            }

            // draw glyph lines scaled to cell
            foreach (var seg in glyph.lines)
            {
                double x1 = cx + seg.x1 * cellW;
                double y1 = cy + seg.y1 * cellH;
                double x2 = cx + seg.x2 * cellW;
                double y2 = cy + seg.y2 * cellH;
                Drawing.LineZ(x1, y1, x2, y2, color, thickness, blend, opacity);
            }

            // advance
            cx += ch == ' ' ? spaceAdvance : advance;
        }
    }
}
